<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <script defer>
        
        let checked = false;
        let screenDiv = undefined;
        let screenRect = undefined;
        let indicator = undefined;
        let pingSpan = undefined;
        let connsEl = undefined;
        let pingsEl = undefined;
        let screenIndicator = undefined;

        let lastUpdate = new Date();
        let url = window.location.host;
        let mouseWs = new WebSocket(`ws://${url}/ws/mouse`);
        let infoWs = new WebSocket(`ws://${url}/ws/info`);
        let lastInfoRequest = new Date();


        setInterval(() => {
            if(infoWs.OPEN) {
                lastInfoRequest = new Date();
                infoWs.send("data");
            }
        }, 1000);

        function getKeys(text) {
            let keys = new Map();
            text.split(";").forEach(element => {
                let [key,val] = element.split("=");
                keys.set(key,val);
            });
            return keys;
        }

        infoWs.addEventListener("message", async (e) => {
            if(pingSpan) {
                pingSpan.innerHTML = new Date().getTime() - lastInfoRequest;
            }
            let keys = getKeys(e.data.toString());
            if(keys.get("auth_required")) {
                window.location.href="/login";
            }

            connsEl.innerHTML = keys.get("conns");            
            pingsEl.innerHTML = "";

            keys.delete("conns");

            for(const [user, pingMs] of keys.entries()) {
                let listItem = document.createElement("li");
                listItem.innerText=`${user}: ${pingMs}ms`;
                pingsEl.appendChild(listItem);
            }
            return false;
        });
        infoWs.addEventListener("close", (e) => {
            console.log("Connection closed", e);
        })
        infoWs.addEventListener("error", (e) => {
            console.log("Error in ws: ", e);
        })
        infoWs.addEventListener("open", () => {
            console.log("Connected to info ws");
        });

        mouseWs.addEventListener("message", async (e) => {
            let keys = getKeys(e.data.toString());
            if(keys.get("auth_required")) {
                window.location.href="/login";
            }
            return false;
        });
        mouseWs.addEventListener("close", (e) => {
            console.log("Connection closed", e);
        })
        mouseWs.addEventListener("error", (e) => {
            console.log("Error in ws: ", e);
        })
        mouseWs.addEventListener("open", () => {
            console.log("Connected to mouse ws");
        });

        window.addEventListener("DOMContentLoaded", function() {
            document.getElementById("mousefollow").addEventListener("change", () => {checked = !checked})
            screenDiv = document.getElementById("screen")
            screenRect = screenDiv.getBoundingClientRect();
            indicator = document.getElementById("indicator");
            pingSpan = document.getElementById("ping");
            pingsEl = document.getElementById("pings");
            connsEl = document.getElementById("conns");
            screenDiv.offsetTop;
            screenIndicator = document.getElementById("screen-indicator");
    
            document.getElementById("vol").addEventListener("input", e => {
                document.getElementById("vol-percentage").innerText=e.srcElement.value;
            })
        }, false);

        function getCoords(event) {
            let top =  window.pageYOffset + screenRect.top;
            let left = window.pageXOffset + screenRect.left;

            let clientX = window.pageXOffset + event.clientX;
            let clientY = window.pageYOffset + event.clientY;
            console.log(screenDiv.offsetTop);
            let relative_x = (clientX - left) / screenRect.width;
            let relative_y = (clientY - top) / screenRect.height;

            let x = Math.round(relative_x*1280); // Target machines scaling is 150% of 1920x1200
            let y = Math.round(relative_y*800);
            console.log(x,y);
            return [x,y];
        }

        addEventListener("scroll", async (event) => {

            screenRect = screenDiv.getBoundingClientRect();
        })
        
        addEventListener("mousemove", async (event) => {
            let top =  window.pageYOffset + screenRect.top;
            let left = window.pageXOffset + screenRect.left;
            let right = window.pageXOffset + screenRect.right;
            let bottom = window.pageYOffset + screenRect.bottom;

            let clientX = window.pageXOffset + event.clientX;
            let clientY = window.pageYOffset + event.clientY;
            if(!checked) {
                console.log("Not checked");
                return;
            }
            if(event.ctrlKey) {
                screenDiv.classList.add("disabled")
                console.log("CTRL held");
                return;
            } else {
                screenDiv.classList.remove("disabled")
            }
            if(((new Date().getTime() - lastUpdate.getTime())/1000) < 0.05) {
                return
            }
            lastUpdate = new Date();
            if(!screenRect) {
                return;
            }
            if(clientY < top || clientY > bottom) {
                return
            }
            if(clientX > right || clientX < left) {
                return
            }

            let [x,y] = getCoords(event);
            mouseWs.send(`pos=${x},${y};type=mouse`);
            if(indicator) {
                screenIndicator.style["top"] = (event.pageY-6)+"px";
                screenIndicator.style["left"] = (event.pageX-6)+"px";
                indicator.style["opacity"] = 1;
                setTimeout(() => {
                    indicator.style["opacity"] = 0;
                }, 20);
            }
        });

        addEventListener("mousedown", (event) => {
            let top =  window.pageYOffset + screenRect.top;
            let left = window.pageXOffset + screenRect.left;
            let right = window.pageXOffset + screenRect.right;
            let bottom = window.pageYOffset + screenRect.bottom;

            let clientX = window.pageXOffset + event.clientX;
            let clientY = window.pageYOffset + event.clientY;
            if(!checked) {
                return;
            }
            if(!screenRect) {
                console.log("Screenrect not init");
                return;
            }
            if(clientY < top || clientY > bottom) {
                return
            }
            if(clientX > right || clientX < left) {
                return
            }

            let [x,y] = getCoords(event);
            
            screenIndicator.style["background-color"] = "blue";
            mouseWs.send(`pos=${x},${y};type=ldown`);
        })

        addEventListener("mouseup", (event) => {
            if(!checked) {
                return;
            }
            if(!screenRect) {
                console.log("Screenrect not init");
                return;
            }
            if(event.clientY < screenRect.top || event.clientY > screenRect.bottom) {
                return
            }
            if(event.clientX > screenRect.right || event.clientX < screenRect.left) {
                return
            }
            let [x,y] = getCoords(event);
            screenIndicator.style["background-color"] = "black";
            mouseWs.send(`pos=${x},${y};type=lup`);
        })


        function sendCaps() {
            fetch(`/send/do/caps/toggle`, {method: "POST"});
        }

        function lockDevice() {
            fetch(`/send/do/lock/_`, {method: "POST"});
        }

        function altf4() {
            fetch(`/send/do/close/_`, {method: "POST"});
        }

        function openPath() {
            let path = document.getElementById("path").value;
            fetch(`/send/do/link/${encodeURIComponent(path)}`, {method: "POST"});
        }

        function sendDialog() {
            let title = document.getElementById("dialog-title").value;
            let desc = document.getElementById("dialog-description").value;

            fetch(`/send/do/dialog/${encodeURIComponent(title)}.,.${encodeURIComponent(desc)}`, {method: "POST"});
        }

        function createSession() {
            fetch("/api/session", {
                method: "POST"
            }).then(data => data.text()).then(session => {
                alert(session)
            })
        }

        function logout() {
            document.cookie="auth=";
            window.location.reload();
        }
        function logoutAll() {
            fetch("/api/session", {
                method: "DELETE"
            });            
        }

        function setVolume() {
            let volume = document.getElementById("vol").value;
            fetch(`/send/do/volume/${volume}`, {method: "POST"});
        }
    </script>
    <style>
        .disabled {
            cursor: not-allowed;
        }

        .stats {
            position: fixed;
            outline-style: dashed;
            outline-width: 2px;
            border-radius: 0.5em;
            min-height: 2em;
        }
        #indicator {
            width: 1rem;
            aspect-ratio: 1;
            border-radius: 0.5em;
            opacity: 0;
            background-color: rgb(38, 255, 0);
        }
    </style>
  </head>
  <body>
    <div class="stats p-2 left-[15px] top-[15px]">
        <div class="flex">
            <div id="indicator"></div>
            <p>Ping: <span id="ping">0</span>ms (server)</p>
        </div>
        <p>Connections: <span id="conns">loading</span></p>
        <p>Pings:</p>
        <ul id="pings">

        </ul>
    </div>

    <div class="stats flex flex-col p-2 right-[15px] top-[15px]">
        <button onclick="createSession()">New session</button>
        <button onclick="logout()">Logout</button>
        <button onclick="logoutAll()">Logout all</button>
    </div>
<div class="flex flex-col items-center space-y-4 p-4">
    <button type="button"
        onclick="sendCaps()"
          class="px-6 py-2.5 rounded-lg cursor-pointer text-white text-sm tracking-wider font-medium border-0 outline-0 outline-none bg-green-700 hover:bg-green-800 active:bg-green-700"
    >Toggle caps</button>

    <button type="button"
            onclick="altf4()"
          class="px-6 py-2.5 rounded-lg cursor-pointer text-white text-sm tracking-wider font-medium border-0 outline-0 outline-none bg-red-700 hover:bg-red-800 active:bg-red-700"
    >Alt+F4</button>

    <button type="button"
            onclick="lockDevice()"
          class="px-6 py-2.5 rounded-lg cursor-pointer text-white text-sm tracking-wider font-medium border-0 outline-0 outline-none bg-red-700 hover:bg-red-800 active:bg-red-700"
    >Lock</button>

    <div class="open max-w-[768px] w-full space-y-2">
        <input id="path" type="text" class="w-full text-slate-900 text-sm border border-slate-300 px-4 py-3 pr-8 rounded-md outline-blue-600" placeholder="Link or path" />
          <button type="button"
                onclick="openPath()"
                class="px-6 py-2.5 rounded-lg cursor-pointer text-white text-sm tracking-wider font-medium border-0 outline-0 outline-none bg-blue-700 hover:bg-blue-800 active:bg-blue-700"
        >Open (link or path)</button>
    </div>

    <div class="volume flex flex-col">
        <label for="vol">Volume (<span id="vol-percentage">unset</span>%)</label>
        <input class="w-[50vw]" step="1{}" id="vol" type="range" min="0" max="100">
        <button onclick="setVolume()" class="w-[120px] px-6 py-2.5 rounded-lg cursor-pointer text-white text-sm tracking-wider font-medium border-0 outline-0 outline-none bg-green-700 hover:bg-green-800 active:bg-green-700">Apply</button>
    </div> 

    <div class="open max-w-[768px] w-full space-y-2">
        <input id="dialog-title" type="text" class="w-full text-slate-900 text-sm border border-slate-300 px-4 py-3 pr-8 rounded-md outline-blue-600" placeholder="Dialog title" />
        <input id="dialog-description" type="text" class="w-full text-slate-900 text-sm border border-slate-300 px-4 py-3 pr-8 rounded-md outline-blue-600" placeholder="Dialog description" />
        <button type="button"
                onclick="sendDialog()"
                class="px-6 py-2.5 rounded-lg cursor-pointer text-white text-sm tracking-wider font-medium border-0 outline-0 outline-none bg-blue-700 hover:bg-blue-800 active:bg-blue-700"
        >Open dialog</button>
    </div>

    <div class="flex space-y-2 items-center">
        <label for="mousefollow" class="m-0 mr-2">Enable mouse follow</label>
        <input type="checkbox" id="mousefollow">
    </div>
    <div id="screen-indicator" class="absolute rounded-xl bg-black w-[1em] aspect-square"></div>
    <p class="select-none pointer-events-none">CTRL to temporarily stop movement</p>
    <div id="screen" class="screen aspect-[16/10] w-[80vw] bg-gray-200"></div>
   
  </body>
</html>