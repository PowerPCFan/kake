<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script defer>
        
        let checked = false;
        let screenDiv = undefined;
        let screenRect = undefined;
        let indicator = undefined;
        let pingSpan = undefined;
        let connsEl = undefined;
        let pingsEl = undefined;
        let screenIndicator = undefined;

        let lastUpdate = new Date();
        let url = window.location.host;
        let mouseWs = new WebSocket(`ws://${url}/ws/mouse`);
        let infoWs = new WebSocket(`ws://${url}/ws/info`);
        let lastInfoRequest = new Date();

        let w = Number(localStorage.getItem("screen.w") || 1920);
        let h = Number(localStorage.getItem("screen.h") || 1080);
        let scaling = Number(localStorage.getItem("screen.sc") || 1.0);


        setInterval(() => {
            if(infoWs.OPEN) {
                lastInfoRequest = new Date();
                infoWs.send("data");
            }
        }, 1000);

        function getKeys(text) {
            let keys = new Map();
            text.split(";").forEach(element => {
                let [key,val] = element.split("=");
                keys.set(key,val);
            });
            return keys;
        }

        infoWs.addEventListener("message", async (e) => {
            if(pingSpan) {
                pingSpan.innerHTML = new Date().getTime() - lastInfoRequest;
            }
            let keys = getKeys(e.data.toString());
            if(keys.get("auth_required")) {
                window.location.href="/login";
            }

            connsEl.innerHTML = keys.get("conns");            
            pingsEl.innerHTML = "";

            keys.delete("conns");

            for(const [user, pingMs] of keys.entries()) {
                let listItem = document.createElement("li");
                listItem.innerText=`${user}: ${pingMs}ms`;
                pingsEl.appendChild(listItem);
            }
            return false;
        });
        infoWs.addEventListener("close", (e) => {
            console.log("Connection closed", e);
        })
        infoWs.addEventListener("error", (e) => {
            console.log("Error in ws: ", e);
        })
        infoWs.addEventListener("open", () => {
            console.log("Connected to info ws");
        });

        mouseWs.addEventListener("message", async (e) => {
            let keys = getKeys(e.data.toString());
            if(keys.get("auth_required")) {
                window.location.href="/login";
            }
            return false;
        });
        mouseWs.addEventListener("close", (e) => {
            console.log("Connection closed", e);
        })
        mouseWs.addEventListener("error", (e) => {
            console.log("Error in ws: ", e);
        })
        mouseWs.addEventListener("open", () => {
            console.log("Connected to mouse ws");
        });

        window.addEventListener("DOMContentLoaded", function() {
            document.getElementById("mousefollow").addEventListener("change", () => {checked = !checked})
            screenDiv = document.getElementById("screen")
            screenRect = screenDiv.getBoundingClientRect();
            indicator = document.getElementById("indicator");
            pingSpan = document.getElementById("ping");
            pingsEl = document.getElementById("pings");
            connsEl = document.getElementById("conns");
            screenDiv.offsetTop;
            screenIndicator = document.getElementById("screen-indicator");

            document.getElementById("width").value = w;
            document.getElementById("height").value = h;
            document.getElementById("scaling").value = scaling*100;
    
            document.getElementById("vol").addEventListener("input", e => {
                document.getElementById("vol-percentage").innerText=e.srcElement.value;
            })
        }, false);

        function getCoords(event) {
            let top =  window.pageYOffset + screenRect.top;
            let left = window.pageXOffset + screenRect.left;

            let clientX = window.pageXOffset + event.clientX;
            let clientY = window.pageYOffset + event.clientY;
            let relative_x = (clientX - left) / screenRect.width;
            let relative_y = (clientY - top) / screenRect.height;

            let scaledHeight = h/scaling;
            let scaledWidth = scaledHeight*(w/h);
            let x = Math.round(relative_x*scaledWidth);
            let y = Math.round(relative_y*scaledHeight);
            return [x,y];
        }

        addEventListener("scroll", async (event) => {

            screenRect = screenDiv.getBoundingClientRect();
        })
        
        addEventListener("mousemove", async (event) => {
            let top =  window.pageYOffset + screenRect.top;
            let left = window.pageXOffset + screenRect.left;
            let right = window.pageXOffset + screenRect.right;
            let bottom = window.pageYOffset + screenRect.bottom;

            let clientX = window.pageXOffset + event.clientX;
            let clientY = window.pageYOffset + event.clientY;
            if(!checked) {
                return;
            }
            if(event.ctrlKey) {
                screenDiv.classList.add("disabled")
                console.log("CTRL held");
                return;
            } else {
                screenDiv.classList.remove("disabled")
            }
            if(((new Date().getTime() - lastUpdate.getTime())/1000) < 0.06) {
                return
            }
            lastUpdate = new Date();
            if(!screenRect) {
                return;
            }
            if(clientY < top || clientY > bottom) {
                return
            }
            if(clientX > right || clientX < left) {
                return
            }

            let [x,y] = getCoords(event);
            mouseWs.send(`pos=${x},${y};type=m`);
            if(indicator) {
                screenIndicator.style["top"] = (event.pageY-6)+"px";
                screenIndicator.style["left"] = (event.pageX-6)+"px";
                indicator.style["opacity"] = 1;
                setTimeout(() => {
                    indicator.style["opacity"] = 0;
                }, 20);
            }
        });

        addEventListener("mousedown", (event) => {
            let top =  window.pageYOffset + screenRect.top;
            let left = window.pageXOffset + screenRect.left;
            let right = window.pageXOffset + screenRect.right;
            let bottom = window.pageYOffset + screenRect.bottom;

            let clientX = window.pageXOffset + event.clientX;
            let clientY = window.pageYOffset + event.clientY;
            if(!checked) {
                return;
            }
            if(!screenRect) {
                console.log("Screenrect not init");
                return;
            }
            if(clientY < top || clientY > bottom) {
                return
            }
            if(clientX > right || clientX < left) {
                return
            }

            let [x,y] = getCoords(event);
            
            screenIndicator.style["background-color"] = "blue";
            mouseWs.send(`pos=${x},${y};type=ld`);
        })

        addEventListener("mouseup", (event) => {
            if(!checked) {
                return;
            }
            if(!screenRect) {
                console.log("Screenrect not init");
                return;
            }
            if(event.clientY < screenRect.top || event.clientY > screenRect.bottom) {
                return
            }
            if(event.clientX > screenRect.right || event.clientX < screenRect.left) {
                return
            }
            let [x,y] = getCoords(event);
            screenIndicator.style["background-color"] = "black";
            mouseWs.send(`pos=${x},${y};type=lu`);
        })

        function setScreen() {
            setScreenRes(document.getElementById("width").value, document.getElementById("height").value, document.getElementById("scaling").value);
        }

        function setScreenRes(width, height, _scaling) {
            console.log("Setting screen to", width, height, _scaling);
            let aspectRatio = width/height;
            w = width;
            h = height;
            scaling = _scaling/100;

            localStorage.setItem("screen.w", width);
            localStorage.setItem("screen.h", height);
            localStorage.setItem("screen.sc", scaling);

            document.getElementById("width").value = width;
            document.getElementById("height").value = height;
            document.getElementById("scaling").value = _scaling;
            screenDiv.style["aspect-ratio"] = aspectRatio;
        }


        function sendCaps() {
            fetch(`/send/caps/toggle`, {method: "POST"});
        }

        function lockDevice() {
            fetch(`/send/lock/_`, {method: "POST"});
        }

        function altf4() {
            fetch(`/send/close/_`, {method: "POST"});
        }

        function openPath() {
            let path = document.getElementById("path").value;
            fetch(`/send/link/${encodeURIComponent(path)}`, {method: "POST"});
        }

        function sendDialog() {
            let title = document.getElementById("dialog-title").value;
            let desc = document.getElementById("dialog-description").value;

            fetch(`/send/dialog/${encodeURIComponent(title)}.,.${encodeURIComponent(desc)}`, {method: "POST"});
        }

        function createSession() {
            fetch("/api/session", {
                method: "POST"
            }).then(data => data.text()).then(session => {
                alert(session)
            })
        }

        function logout() {
            document.cookie="auth=";
            window.location.reload();
        }
        function logoutAll() {
            fetch("/api/session", {
                method: "DELETE"
            });            
        }

        function rotateScreen(amountDeg) {
            fetch(`/send/rotate/${amountDeg}`, {method: "POST"});
        }

        function setVolume() {
            let volume = document.getElementById("vol").value;
            fetch(`/send/volume/${volume}`, {method: "POST"});
        }
    </script>
    <style>
        .disabled {
            cursor: not-allowed;
        }

        .stats {
            position: fixed;
            outline-style: dashed;
            outline-width: 2px;
            border-radius: 0.5em;
            min-height: 2em;
            background-color: rgba(255, 255, 255, 0.8);
        }
        #indicator {
            width: 1rem;
            aspect-ratio: 1;
            border-radius: 0.5em;
            opacity: 0;
            background-color: rgb(38, 255, 0);
        }
        button {
            padding: 0.625rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            color: white;
            font-size: 0.875rem;
            letter-spacing: 0.05em;
            font-weight: 500;
            border: 0;
            outline: none;
            background-color: #1D4ED8;
            transition: background-color 0.2s
            }

        button:hover {
            background-color: #1E40AF;
        }

        button:active {
            background-color: #1D4ED8;
        }

        button.green {
            background-color: #19a70c;
        }
        button.green:hover {
            background-color: #18be12;
        }
        button.green:active {
            background-color: #23d81d;
        }

        button.red {
            background-color: #d81d1d;
        }
        button.red:hover {
            background-color: #b61212;
        }
        button.red:active {
            background-color: #d81d1d;
        }

        button.yellow {
            background-color: #d8811d;
        }
        button.yellow:hover {
            background-color: #f3a71a;
        }
        button.yellow:active {
            background-color: #d8871d;
        }
    </style>
  </head>
  <body>
    <div class="stats p-2 left-[15px] top-[15px]">
        <div class="flex">
            <div id="indicator"></div>
            <p>Ping: <span id="ping">0</span>ms (server)</p>
        </div>
        <p>Connections: <span id="conns">loading</span></p>
        <p>Pings:</p>
        <ul id="pings">

        </ul>
    </div>

    <div class="stats flex flex-col p-2 right-[15px] top-[15px]">
        <button onclick="createSession()">New session</button>
        <button onclick="logout()">Logout</button>
        <button onclick="logoutAll()">Logout all</button>
    </div>
<div class="flex flex-col items-center space-y-4 p-4">
    <button type="button"
        onclick="sendCaps()"
          class="green"
    >Toggle caps</button>

    <button type="button"
            onclick="altf4()"
          class="red"
    >Alt+F4</button>

    <button type="button"
            onclick="lockDevice()"
          class="red"
    >Lock</button>

    <div class="open max-w-[768px] w-full space-y-2">
        <input id="path" type="text" class="w-full text-slate-900 text-sm border border-slate-300 px-4 py-3 pr-8 rounded-md outline-blue-600" placeholder="Link or path" />
          <button type="button"
                onclick="openPath()"
        >Open (link or path)</button>
    </div>

    <div class="volume flex flex-col">
        <label for="vol">Volume (<span id="vol-percentage">unset</span>%)</label>
        <input class="w-[50vw]" step="1{}" id="vol" type="range" min="0" max="100">
        <button onclick="setVolume()" class="green w-[120px]">Apply</button>
    </div> 

    <div class="open max-w-[768px] w-full space-y-2">
        <input id="dialog-title" type="text" class="w-full text-slate-900 text-sm border border-slate-300 px-4 py-3 pr-8 rounded-md outline-blue-600" placeholder="Dialog title" />
        <input id="dialog-description" type="text" class="w-full text-slate-900 text-sm border border-slate-300 px-4 py-3 pr-8 rounded-md outline-blue-600" placeholder="Dialog description" />
        <button type="button"
                onclick="sendDialog()"
        >Open dialog</button>
    </div>
    <div class="content max-w-[768px] flex w-full justify-between mb-8 mt-4">
        <div x-data="{ duration: 1000 }" class="flex flex-col">
            <h1 class="text-xl">Beep</h1>
            <label for="beep">Duration (<span x-text="duration"></span>ms)</label>
            <input x-model="duration" id="duration" type="range" step="100" min="100" max="9000">
            <button x-on:click="() => {
                fetch(`/send/beep/${duration}`, {method: 'POST'})
            }" class="yellow">Start</button>
        </div>
        
        <div class="flex flex-col space-y-2">
            <h1 class="text-xl">Rotate screen</h1>
            <button type="button"
                onclick="rotateScreen(0)"
            >^</button>
            <button type="button"
                onclick="rotateScreen(180)"
            >v</button>
        </div>
    </div>

    <h1 class="text-xl w-fit mt-8">Screen control</h1>
    <div id="screen-indicator" class="top-[-100px] absolute rounded-xl bg-black w-[1em] aspect-square"></div>
    <div class="screen-custom">
        <div class="flex">
            <div>
                <label for="width">width (px)</label>
                <input class="w-full text-slate-900 text-sm border border-slate-300 px-4 py-3 pr-8 rounded-md outline-blue-600" type="number" id="width" placeholder="1920">
            </div>
            <div>
                <label for="height">height (px)</label>
                <input class="w-full text-slate-900 text-sm border border-slate-300 px-4 py-3 pr-8 rounded-md outline-blue-600" type="number" id="height" placeholder="1080">
            </div>
            <div>
                <label for="scaling">scaling (%)</label>
                <input class="w-full text-slate-900 text-sm border border-slate-300 px-4 py-3 pr-8 rounded-md outline-blue-600" type="number" id="scaling" placeholder="100">
            </div>
        </div>
        <hr class="opacity-[0.2] mt-4">
        <button onclick="setScreen()" class="w-[120px] green">Apply</button>


        <button type="button"
                onclick="setScreenRes(1920, 1200, 150)"
        >Preset: Lenovo school laptop</button>
        <button type="button"
                onclick="setScreenRes(1920, 1080, 100)"
                class="yellow"
        >Preset: 1080p desktop</button>
        <button type="button"
                onclick="setScreenRes(2560, 1440, 125)"
                class="yellow"
        >Preset:1440p desktop (125% scaling)</button>
    </div>

    <div class="flex space-y-2 items-center">
        <label for="mousefollow" class="m-0 mr-2">Enable mouse follow</label>
        <input type="checkbox" id="mousefollow">
    </div>
    <p class="select-none pointer-events-none">CTRL to temporarily stop movement</p>
    <div id="screen" class="screen aspect-[16/10] w-[80vw] bg-gray-200"></div>
  </body>
</html>